---
output: github_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", cache = TRUE
)
```

# STATcubeR <img src="man/figures/STATcube_logo.png" align="right" alt="" width="120" />

R Interface für die STATcube REST API

## Setup

Zum erstmaligen Verwenden des Pakets ist es notwendig, das Paket zu installieren
und einen API Schlüssel hinzuzufügen. Eine Anleitung hierzu kann in dem
[Setup Artikel](http://xlwt0012/rpkgs/dev/STATcubeR/articles/Setup.html)
gefunden werden.

## Verwendung

Zur Verwendung diese Paketes sind folgende Schritte notwendig

* Herunterladen einer API Abfrage von STATcube. (JSON-Format)
* Absenden der Abfrage über den R Server
* Konvertieren der API-Response in ein typisches R Datenformat

### Herunterladen der API Abfrage

Laden sie eine "Open Data API Abfrage" über die STATcube GUI herunter. Erstellen
Sie hierzu eine STATcube Tabelle und wählen Sie "API Abfrage" als
Download-Option.

![](man/figures/download_json.png)

Nun wird eine json-Datei auf dem Windows-System abgelegt

### Absenden der Abfrage

Geben Sie den Pfad zu dem heruntergeladenen JSON-File in
der Funktion `sc_get_response()` ein, um die API Abfrage auszuführen.

``` r
my_response <- sc_get_response("pfad/zu/api_abfrage.json")
```

Alternativ kann mit der Funktion `sc_upload_json()` die json-Datei über einen
Upload-Dialog angegeben werden.

```r
my_response <- sc_upload_json()
```

Das Objekt `my_response` beinhaltet die "rohe" API-Response. Die Print-Methode
gibt einen Einblick in die Abfrage.

```{r, include=FALSE}
pkgload::load_all(export_all = FALSE, reset = FALSE, helpers = FALSE)
conflicted::conflict_prefer("filter", "dplyr")
```

```{r}
(json_pfad <- sc_example("bev_seit_1982.json"))
my_response <- sc_get_response(json_pfad)
my_response
```

### Umwandeln in typische R-Datenformate

Um die importierten Daten in R zu nutzen kann `as.data.frame()` oder
`as.array()` verwendet werden.

```r
as.array(my_response)
as.data.frame(my_response)
```

Im Falle von `as.data.frame()` wird ein tidy Datensatz zurückgegeben, der jede
Dimension des Cubes als Spalte enthält. Außerdem gibt es zwei Spalten pro
Wert. Beispiel:

```{r}
set.seed(1234)
as.data.frame(my_response) %>% dplyr::sample_n(10)
```

Die Spalte `Fallzahl_a` enthält die Anmerkungen (Annotations) zur Spalte
`Fallzahl`. Um die Bedeutungen der Annotations zu sehen kann
`sc_annotation_legend()` verwendet werden.

```{r}
sc_annotation_legend(my_response)
```

In diesem Fall ist der Nuller in Zeile 2 ein "echter nuller" und der Nuller
in Zeile 1 steht für einen gesperrten Wert.

### Sonstiges

Um den Inhalt der Response zu erhalten, kann `sc_content()` verwendet werden.

```{r}
my_content <- sc_content(my_response)
names(my_content)
my_content$measures
```

Die Endpoints `/info`, `/schema` und `/rate_limit` sind testweise angebunden
aber noch nicht exportiert.

```r
STATcubeR:::sc_get_info() %>% httr::content()
STATcubeR:::sc_get_schema() %>% httr::content()
STATcubeR:::sc_get_rate_limit() %>% httr::content()
```

Gespeicherte Tabellen lassen sich über die `id` laden. Hierzu ist kein
JSON notwendig.

```{r}
sc_saved_tables_list()
tourism_ts <- sc_saved_table("str:table:eec7dd70-25c4-4e5a-a6ae-1a9cd15d3c4c")
tourism_ts
```

Diese Tabellen können nun auch als json exportiert werden

```{r}
sc_write_json(tourism_ts, "tourism_ts.json")
```

STATcube verfügt über einen Cache. Wenn die selbe Abfrage mehrmals abgeschickt
wird, so wird das Rate-Limit (100 Anfragen pro Stunde) nicht belastet.
Sämtliche Anfragen werden an die externe STATcube Instanz gesendet. Eine
Überlastung der API kann somit die UX von externen Nutzern negativ beeinflussen.

## TODO

Vorschläge zur weiterentwicklung des Pakets können in dem
[TODO Artikel](http://xlwt0012/rpkgs/dev/STATcubeR/articles/TODO.html)
nachgelesen werden.

## API Dokumentation

* `/table` Endpoint: https://docs.wingarc.com.au/superstar/latest/open-data-api/open-data-api-reference/table-endpoint
* `/schema` Endpoint: https://docs.wingarc.com.au/superstar/latest/open-data-api/open-data-api-reference/schema-endpoint
