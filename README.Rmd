---
output: github_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# STATcubeR <img src="man/figures/logo.png" align="right" alt="" width="120" />

<!-- badges: start -->
[![Travis build status](https://travis-ci.org/statistikat/STATcubeR.svg?branch=master)](https://travis-ci.org/statistikat/STATcubeR)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![GitHub last commit](https://img.shields.io/github/last-commit/statistikat/STATcubeR.svg?logo=github)](https://github.com/statistikat/STATcubeR/commits/master)
[![GitHub code size in bytes](https://img.shields.io/github/languages/code-size/statistikat/STATcubeR?logo=github)](https://github.com/statistikat/STATcubeR)
<!-- badges: end -->

R Interface for the STATcube REST API. This package exposes certain parts
of the [SuperSTAR API] to transfer your STATcube tables into R.

Note that the API is currently only available inside the firewall of Statistics
Austria. Support for external users will be available in 2021.

## Setup

See the [setup article] for instructions on how to install the package
and set your API key.

## Usecase: JSON-Request

In the following example, a table will be exported from STATcube into an
R session. This process involves four steps

* create a table with the STATcube GUI (table view)
* download an "API request" for the table (format: `*.json`).
* send the `json` file to the API using `STATcubeR`.
* convert the return value into a `data.frame`

### Create a table with the STATcube GUI

Use the graphical user interface of STATcube to create a table. Visit
[STATcube] and select a database. This will open the table view where you can 
create a table. See the [STATcube manual] for details.

### Download an API request

Choose "Open Data API Abfrage (.json)" in the download options. This will
save a json file on your local file system.

 <img src="man/figures/download_json.png" />

### Send the json to the API

Provide the path to the downloaded file in `sc_post_json()`.

``` r
my_response <- sc_post_json("path/to/api_request.json")
```

The object `my_response` contains the raw API response from `httr::POST()`
against the [`/table` endpoint]. Printing the object will summarize the request.

```{r, include=FALSE}
pkgload::load_all(export_all = FALSE, reset = FALSE, helpers = FALSE) 
conflicted::conflict_prefer("filter", "dplyr")
```

```{r, cache = TRUE}
(json_path <- sc_example("bev_seit_1982.json"))
my_response <- sc_post_json(json_path)
my_response
```

### Convert into a data frame

The return value of `sc_post_json()` can be converted into a `data.frame`
using the generic function `as.data.frame()`.

```r
as.data.frame(my_response)
```

This will produce a tidy table, which contains a column for each field
of the table. Furthermore, two columns will be present for each measure

```{r}
as.data.frame(my_response) %>% .[c(1:4, 19:24), ]
```

The column `Number_a` contains annotations for the column
`Number`. In order to get explanations about those annotations, use the
function `sc_annotation_legend()`.

```{r}
sc_annotation_legend(my_response)
```

In this case, we see that row 21 contains a value `NA` (**N**ot **A**vailable)
because the value is not disclosed ("Crosstabulation not allowed"). However, the
zero value in row 20 can be considered a "real zero value" because no
annotations are provided.

## Usecase: Saved Table

If saved tables are present in STATcube, those can be imported without
downloading a json file. All saved tables can be shown with
`sc_saved_tables_list()`.

```{r, cache = TRUE}
sc_saved_tables_list()
```

Subsequently the `id` of a saved table can be used to import the table into R.

```{r, cache = TRUE}
tourism_ts <- sc_saved_table("str:table:eec7dd70-25c4-4e5a-a6ae-1a9cd15d3c4c")
tourism_ts
```

To make the table available for other users of `STATcubeR`, the response can
be exported into a json.

```{r}
sc_write_json(tourism_ts, "tourism_ts.json")
```

```{r, include=FALSE}
on.exit(fs::file_delete("tourism_ts.json"))
```

The generated json file contains an API request that can be used in
`sc_post_json()`.

```r
my_response <- sc_post_json("tourism_ts.json")
```

## Misc

To get the raw API response content, use `sc_content()`. This function returns
a nested list, containing data and metadata about the table.

```{r}
my_content <- sc_content(my_response)
names(my_content)
my_content$measures
```

There is experimental support for the endpoints [`/info`], [`/schema`] and
[`/rate_limit`]. However, those endpoints are not exported by now.

```r
STATcubeR:::sc_get_info() %>% httr::content()
STATcubeR:::sc_get_schema() %>% httr::content()
STATcubeR:::sc_get_rate_limit() %>% httr::content()
```

STATcube uses caching for the `/table` endpoint by default. If the same
request to `sc_post_json()` is sent several times, this will not count
towards the rate-limit (100 requests per hour).

## API documentation

* [`/table` endpoint] 
* [`/schema` endpoint]

[setup article]: https://statistikat.github.io/STATcubeR/articles/articles/Setup.html
[SuperSTAR API]: https://docs.wingarc.com.au/superstar/latest/open-data-api
[STATcube manual]: http://www.statistik.at/wcm/idc/idcplg?IdcService=GET_PDF_FILE&dDocName=105692
[`/table` endpoint]: https://docs.wingarc.com.au/superstar/latest/open-data-api/open-data-api-reference/table-endpoint
[`/schema` endpoint]: https://docs.wingarc.com.au/superstar/latest/open-data-api/open-data-api-reference/schema-endpoint
[STATcube]: http://sdbext:8081/statistik.at/ext/statcube/home
[`/info`]: https://docs.wingarc.com.au/superstar/latest/open-data-api/open-data-api-reference/info-endpoint
[`/schema`]: https://docs.wingarc.com.au/superstar/latest/open-data-api/open-data-api-reference/schema-endpoint
[`/rate_limit`]: https://docs.wingarc.com.au/superstar/latest/open-data-api/open-data-api-reference/rate-limit
